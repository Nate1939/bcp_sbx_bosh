#!/bin/bash
#
# executable: deployments/BcP-bosh/deploy
#
# Deploy the BcP BOSH Director
#
set -euo pipefail

##
# Set our current working directory to the root of the BcP repo
#
scriptAbsolutePath="$(dirname "$(readlink -f "$BASH_SOURCE")")"
cd "$scriptAbsolutePath/../../"

##
# BcP Setup
# Validates the current setup and guides the user if deviations are found
#
. ".scripts/setup.sh"

##
# !! DEPLOYMENT METADATA !!
#    Must be filled out!
#
DEPLOYMENT_NAME="BcP-bosh"
DEPLOYMENT_DIRECTOR="BcP-bosh"

echo_deployment_metadata

##
# An array of external dependencies (clones) for this deployment.
# The array must contain the git repository URLs for the dependencies.
# Example:
#   "https://github.com/cloudfoundry/bosh-deployment.git"
#   "https://github.com/cloudfoundry/cf-deployment.git"
#
declare -a dependencies=(
    "https://github.com/cloudfoundry/bosh-deployment.git"
)

load_dependencies "${dependencies[@]}"

##
# Check if the Director is already initialized
#
check_if_target_director_is_initialized "$DEPLOYMENT_DIRECTOR" "true"

##
# BOSH Deployment Definition
#
bosh create-env "clones/bosh-deployment/bosh.yml" \
    --state="deployments/$DEPLOYMENT_NAME/state.json" \
    --vars-store="deployments/$DEPLOYMENT_NAME/creds.yml" \
    -v director_name="$DEPLOYMENT_NAME" \
    -v internal_ip="10.64.159.4" \
    -v internal_gw="10.64.159.1" \
    -v internal_cidr="10.64.159.0/26" \
    -o "clones/bosh-deployment/vsphere/cpi.yml" \
        -v network_name="nnn-BcP-core-sz.nnn1.osl.zzz.net" \
        -v vcenter_dc="CAP-ppp" \
        -v vcenter_cluster="nnn-Dual-OSL" \
        -v vcenter_ds="^nnn-san-std-dual-.*$" \
        -v vcenter_ip="10.76.38.4" \
        -v vcenter_user="$(vault kv get -field=iaas-vcenter-user platform/credentials)" \
        -v vcenter_password="$(vault kv get -field=iaas-vcenter-password platform/credentials)" \
        -v vcenter_templates="$DEPLOYMENT_NAME-templates" \
        -v vcenter_vms="$DEPLOYMENT_NAME-vms" \
        -v vcenter_disks="$DEPLOYMENT_NAME-disks" \
    -o "clones/bosh-deployment/misc/ntp.yml" \
        -v internal_ntp='["nnn-co-ad1.xxx.yz", "nnn-co-ad2.xxx.yz"]' \
    -o "clones/bosh-deployment/misc/proxy.yml" \
        -v http_proxy="http://proxy.xxx.yz:8080" \
        -v https_proxy="http://proxy.xxx.yz:8080" \
        -v no_proxy="localhost,bosh,xxx.yz,zzz.net,.0,.1,.2,.3,.4,.5,.6,.7,.8,.9,.10,.11,.12,.13,.14,.15,.16,.17,.18,.19,.20,.21,.22,.23,.24,.25,.26,.27,.28,.29,.30,.31,.32,.33,.34,.35,.36,.37,.38,.39,.40,.41,.42,.43,.44,.45,.46,.47,.48,.49,.50,.51,.52,.53,.54,.55,.56,.57,.58,.59,.60,.61,.62,.63,.64,.65,.66,.67,.68,.69,.70,.71,.72,.73,.74,.75,.76,.77,.78,.79,.80,.81,.82,.83,.84,.85,.86,.87,.88,.89,.90,.91,.92,.93,.94,.95,.96,.97,.98,.99,.100,.101,.102,.103,.104,.105,.106,.107,.108,.109,.110,.111,.112,.113,.114,.115,.116,.117,.118,.119,.120,.121,.122,.123,.124,.125,.126,.127,.128,.129,.130,.131,.132,.133,.134,.135,.136,.137,.138,.139,.140,.141,.142,.143,.144,.145,.146,.147,.148,.149,.150,.151,.152,.153,.154,.155,.156,.157,.158,.159,.160,.161,.162,.163,.164,.165,.166,.167,.168,.169,.170,.171,.172,.173,.174,.175,.176,.177,.178,.179,.180,.181,.182,.183,.184,.185,.186,.187,.188,.189,.190,.191,.192,.193,.194,.195,.196,.197,.198,.199,.200,.201,.202,.203,.204,.205,.206,.207,.208,.209,.210,.211,.212,.213,.214,.215,.216,.217,.218,.219,.220,.221,.222,.223,.224,.225,.226,.227,.228,.229,.230,.231,.232,.233,.234,.235,.236,.237,.238,.239,.240,.241,.242,.243,.244,.245,.246,.247,.248,.249,.250,.251,.252,.253,.254,.255" \
    -o "common-ops/remove-job-proxy-config.yml" \
        -v proxy_config_file_paths="/var/vcap/jobs/health_monitor/config/bpm.yml" \
    -o "clones/bosh-deployment/uaa.yml" \
    -o "clones/bosh-deployment/credhub.yml" \
    -o "clones/bosh-deployment/jumpbox-user.yml" \
    -o "clones/bosh-deployment/misc/trusted-certs.yml" \
        --var-file trusted_ca_cert="blobs/xxx-yyy-ca-certs.pem" \
    -o "common-ops/add-trusted-ca-certs-to-director-vm.yml" \
        --var-file director_vm_trusted_ca_certs="blobs/xxx-yyy-ca-certs.pem" \
    -o "common-ops/use-xxx-dns.yml" \
    -o "common-ops/remove-dev-tools-from-vms.yml" \
    -o "common-ops/change-deployment-name.yml" \
        -v deployment_name="$DEPLOYMENT_NAME" \
    -o "common-ops/bosh-uaa-use-xxx-ldap.yml" \
        -v ldap_bind_dn="$(vault kv get -field=ldap-${DEPLOYMENT_NAME}-bind-dn platform/credentials)" \
        -v ldap_bind_password="$(vault kv get -field=ldap-${DEPLOYMENT_NAME}-bind-password platform/credentials)" \
    -o "deployments/BcP-bosh/ops/bosh-uaa-external-group-mappings.yml"

##
# Post-deployment activities
#
if [[ $? -eq 0 ]]; then

    # Set 'creds.yml' and 'state.json' file permissions
    chmod 600 "deployments/$DEPLOYMENT_NAME/creds.yml"
    chmod 600 "deployments/$DEPLOYMENT_NAME/state.json"

    # Sync 'creds.yml' and 'state.json' files to the external stores
    sync_creds_file_to_vault "$DEPLOYMENT_NAME" "sync"
    sync_state_file_to_bitbucket "$DEPLOYMENT_NAME" "sync"

    # Connect to the deployed BOSH Director
    connect_to_bosh $DEPLOYMENT_NAME

    # Upload the Cloud Config to be used by all deployments made by this BOSH Director
    bosh -n update-cloud-config "cloud-config/$DEPLOYMENT_NAME/cloud-config.yml"

    # Ensure we have BOSH DNS available for all deployments made by this BOSH Director
    bosh -n update-runtime-config "clones/bosh-deployment/runtime-configs/dns.yml"

    # Upload Ubuntu Bionic stemcell
    bosh -n upload-stemcell --sha1 4cf0de2078b94dfdeb01ac6e3af7a32c31df5171 \
        https://bosh.io/d/stemcells/bosh-vsphere-esxi-ubuntu-bionic-go_agent?v=1.36

fi

##
# DEPLOYMENT OPERATION COMPLETED!
#
printf "\n\n"
bold_green_msg_nn "FINISHED DEPLOYING: "
green_msg "${DEPLOYMENT_NAME}"
printf "\n\n"